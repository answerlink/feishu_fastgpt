# 群聊支持功能

## 功能概述

系统现已支持群聊功能，包括群聊消息记录和@机器人回复两大核心功能。

### 主要功能

1. **群聊消息记录**
   - 自动记录所有群聊消息到内存
   - 支持消息类型：文本、图片、文件、语音、富文本
   - 自动提取@用户信息

2. **@机器人回复**
   - 支持多种触发模式：at、all、auto
   - 智能上下文感知，回复时包含群聊历史
   - 完全复用单聊的AI回复能力
   - 支持流式卡片回复

## 配置说明

### 必需配置

在应用配置中添加以下设置：

```json
{
  "aichat_reply_group": true,                    // 启用群聊回复功能
  "aichat_reply_group_trigger_mode": "at"       // 触发模式
}
```

### 触发模式说明

- **`"at"`** - 只有@机器人时才回复（推荐）
- **`"all"`** - 回复所有群聊消息
- **`"auto"`** - 自动判断（当前等同于at模式）

> 注：机器人判断是否@自己的前提条件：config配置中app_name需要与飞书机器人名称完全一致。

## 使用示例

### 1. 基础配置

```json
{
  "FEISHU_APPS": [
    {
      "app_id": "cli_a0163xxx",
      "app_secret": "v11k8wGEOdxxx",
      "app_name": "测试应用",
      "aichat_enable": true,
      "aichat_url": "http://127.0.0.1:3000/api/v1/chat/completions",
      "aichat_key": "fastgpt-xxx",
      "aichat_reply_p2p": true,
      "aichat_reply_group": true,
      "aichat_reply_group_trigger_mode": "at"
    }
  ]
}
```

### 2. 群聊使用

1. **加入群聊**：将机器人添加到群聊中
2. **@机器人**：在群消息中@机器人即可触发回复
3. **智能回复**：机器人会结合群聊上下文给出智能回复

## API 接口

### 群聊统计信息

#### 获取指定群聊统计
```bash
GET /api/v1/group-chat/stats/{chat_id}
```

#### 获取群聊消息记录
```bash
GET /api/v1/group-chat/messages/{chat_id}?limit=10
```

#### 获取群聊上下文
```bash
GET /api/v1/group-chat/context/{chat_id}?context_limit=5
```

#### 获取活跃群聊列表
```bash
GET /api/v1/group-chat/active-groups
```

#### 清空群聊记录
```bash
DELETE /api/v1/group-chat/messages/{chat_id}
```

## 工作原理

### 消息记录流程

1. **接收消息**：机器人接收到群聊消息
2. **解析内容**：提取消息内容、发送者、@用户等信息
3. **存储记录**：将消息存储到内存队列（LRU，最多100条）
4. **决策回复**：根据配置和@情况决定是否回复

### @检测机制

1. **mentions字段处理**：解析消息的mentions字段，将@_user_x替换为真实姓名
2. **姓名匹配**：检查@的用户名是否等于机器人的app_name
3. **纯净内容提取**：去除所有@信息，提取问题主体部分
4. **文本内容检查**：备用方案，检查文本中是否直接包含@机器人名称

### 智能回复流程

1. **消息处理**：提取纯净问题内容（去除@信息）
2. **上下文构建**：获取群聊最近5条消息作为上下文
3. **消息组合**：将上下文和纯净问题组合
4. **AI处理**：调用AI服务生成回复
5. **流式响应**：使用卡片形式实时流式显示回复

## 日志示例

### 群聊消息记录
```
[INFO] [group_chat_memory] 群聊 oc_xxx 添加消息: 张三 (text) - 当前消息数: 15
```

### @机器人检测
```
[DEBUG] [feishu_bot] 消息处理结果 - 原始: '@_user_1 你好' -> raw: '@AI助手 你好' -> pure: '你好' -> @bot: True
```

### 上下文回复
```
[INFO] [feishu_bot] 群聊回复包含上下文，上下文长度: 245，纯净问题: '怎么使用这个功能？'
[INFO] [feishu_bot] 流式卡片回复已发送
```

## 注意事项

1. **内存限制**：消息记录仅存储在内存中，重启会丢失
2. **性能考虑**：每个群最多100条消息，避免内存过度使用
3. **权限要求**：确保机器人有群聊消息读取权限
4. **@检测**：使用机器人的app_name进行匹配，确保配置正确的app_name
5. **上下文长度**：默认包含2条历史消息，可根据需要调整
6. **消息处理**：存储raw_content（替换后的完整内容）和pure_content（纯净问题内容）

## 故障排查

### 常见问题

1. **机器人不回复群聊**
   - 检查 `aichat_reply_group` 是否为 true
   - 确认触发模式配置正确
   - 验证是否正确@了机器人

2. **@检测失败**
   - 检查机器人权限配置
   - 确认机器人已加入群聊
   - 查看日志中的@检测结果

3. **上下文丢失**
   - 检查群聊是否有历史消息
   - 确认消息记录功能正常
   - 查看群聊统计接口

## 最佳实践

1. **合理配置触发模式**：推荐使用 `"at"` 模式，避免过度回复
2. **监控内存使用**：定期检查群聊统计，必要时清理记录
3. **权限管理**：确保机器人有必要的群聊权限
4. **用户引导**：告知用户如何正确@机器人获得回复 